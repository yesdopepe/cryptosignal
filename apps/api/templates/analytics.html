{% extends "base.html" %}

{% block content %}
<!-- Page Header -->
<div class="mb-6">
    <h1 class="text-2xl font-bold">Analytics</h1>
    <p class="text-slate-400">Performance metrics and historical data analysis</p>
</div>

<!-- Cache Performance Banner -->
<div class="bg-gradient-to-r from-primary-900/50 to-purple-900/50 rounded-lg border border-primary-700 p-4 mb-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <h3 class="font-semibold text-primary-400">‚ö° Cache Performance Demo</h3>
            <p class="text-sm text-slate-300">These analytics process 100,000+ records with Redis caching for sub-20ms response times.</p>
        </div>
        <button onclick="runBenchmark()" class="px-4 py-2 bg-primary-600 hover:bg-primary-500 rounded-lg text-sm transition-smooth touch-target whitespace-nowrap">
            Run Benchmark
        </button>
    </div>
</div>

<!-- Benchmark Results (hidden initially) -->
<div id="benchmark-results" class="hidden bg-slate-800 rounded-lg border border-slate-700 p-4 mb-6">
    <h3 class="font-semibold mb-4">Cache Benchmark Results</h3>
    <div id="benchmark-content" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Results will be loaded here -->
    </div>
</div>

<!-- Analytics Cards Grid -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Historical Performance Chart -->
    <div class="bg-slate-800 rounded-lg border border-slate-700 p-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-semibold">Signal Performance (30 Days)</h3>
            <span id="historical-cache" class="text-xs text-slate-400"></span>
        </div>
        <div class="h-64">
            <canvas id="performance-chart"></canvas>
        </div>
    </div>
    
    <!-- Sentiment Trend Chart -->
    <div class="bg-slate-800 rounded-lg border border-slate-700 p-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-semibold">Sentiment Trend</h3>
            <select id="sentiment-period" onchange="loadSentimentTrend()" class="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm">
                <option value="7">7 Days</option>
                <option value="30" selected>30 Days</option>
                <option value="90">90 Days</option>
            </select>
        </div>
        <div class="h-64">
            <canvas id="sentiment-trend-chart"></canvas>
        </div>
    </div>
</div>

<!-- Channel Leaderboard -->
<div class="bg-slate-800 rounded-lg border border-slate-700 mb-6">
    <div class="p-4 border-b border-slate-700 flex justify-between items-center">
        <h3 class="font-semibold">Channel Leaderboard</h3>
        <span id="leaderboard-cache" class="text-xs text-slate-400"></span>
    </div>
    
    <!-- Desktop Table -->
    <div class="hidden md:block overflow-x-auto">
        <table class="w-full">
            <thead class="bg-slate-700">
                <tr>
                    <th class="px-4 py-3 text-left text-sm font-medium text-slate-300">Rank</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-slate-300">Channel</th>
                    <th class="px-4 py-3 text-right text-sm font-medium text-slate-300">Signals</th>
                    <th class="px-4 py-3 text-right text-sm font-medium text-slate-300">Success Rate</th>
                    <th class="px-4 py-3 text-right text-sm font-medium text-slate-300">Avg ROI</th>
                    <th class="px-4 py-3 text-right text-sm font-medium text-slate-300">Score</th>
                    <th class="px-4 py-3 text-center text-sm font-medium text-slate-300">Win Streak</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-slate-300">Top Token</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body" class="divide-y divide-slate-700">
                <tr>
                    <td colspan="8" class="px-4 py-8 text-center text-slate-400">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- Mobile Cards -->
    <div class="md:hidden divide-y divide-slate-700" id="leaderboard-cards">
        <div class="p-4 text-center text-slate-400">Loading...</div>
    </div>
</div>

<!-- Token Statistics Grid -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Token Performance -->
    <div class="bg-slate-800 rounded-lg border border-slate-700 p-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-semibold">Token Performance</h3>
            <select id="token-select" onchange="loadTokenStats()" class="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm">
                <option value="BTC">BTC</option>
                <option value="ETH">ETH</option>
                <option value="SOL">SOL</option>
                <option value="DOGE">DOGE</option>
                <option value="PEPE">PEPE</option>
                <option value="SHIB">SHIB</option>
                <option value="LINK">LINK</option>
                <option value="MATIC">MATIC</option>
            </select>
        </div>
        <div id="token-stats" class="space-y-4">
            <div class="text-center text-slate-400 py-8">Select a token to view stats</div>
        </div>
    </div>
    
    <!-- ROI Distribution -->
    <div class="bg-slate-800 rounded-lg border border-slate-700 p-4">
        <h3 class="font-semibold mb-4">ROI Distribution</h3>
        <div class="h-64">
            <canvas id="roi-chart"></canvas>
        </div>
    </div>
</div>

<!-- Market Patterns -->
<div class="bg-slate-800 rounded-lg border border-slate-700 p-4 mb-6">
    <div class="flex justify-between items-center mb-4">
        <h3 class="font-semibold">Detected Market Patterns</h3>
        <span id="patterns-cache" class="text-xs text-slate-400"></span>
    </div>
    <div id="patterns-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="text-center text-slate-400 py-8 col-span-full">Loading patterns...</div>
    </div>
</div>

<!-- Export Section -->
<div class="bg-slate-800 rounded-lg border border-slate-700 p-4">
    <h3 class="font-semibold mb-4">Export Data</h3>
    <div class="flex flex-col sm:flex-row gap-4">
        <button onclick="exportData('csv')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-smooth touch-target">
            üìÑ Export as CSV
        </button>
        <button onclick="exportData('json')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-smooth touch-target">
            üìã Export as JSON
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let performanceChart = null;
    let sentimentTrendChart = null;
    let roiChart = null;
    
    document.addEventListener('DOMContentLoaded', () => {
        initCharts();
        loadAnalyticsData();
    });
    
    function initCharts() {
        // Performance Chart
        const perfCtx = document.getElementById('performance-chart').getContext('2d');
        performanceChart = new Chart(perfCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Avg ROI %',
                    data: [],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        grid: { color: '#334155' },
                        ticks: { color: '#94a3b8' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#94a3b8' }
                    }
                }
            }
        });
        
        // Sentiment Trend Chart
        const sentCtx = document.getElementById('sentiment-trend-chart').getContext('2d');
        sentimentTrendChart = new Chart(sentCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [
                    { label: 'Bullish', data: [], backgroundColor: '#10b981' },
                    { label: 'Bearish', data: [], backgroundColor: '#ef4444' },
                    { label: 'Neutral', data: [], backgroundColor: '#f59e0b' },
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#94a3b8' }
                    }
                },
                scales: {
                    y: {
                        stacked: true,
                        grid: { color: '#334155' },
                        ticks: { color: '#94a3b8' }
                    },
                    x: {
                        stacked: true,
                        grid: { display: false },
                        ticks: { color: '#94a3b8' }
                    }
                }
            }
        });
        
        // ROI Distribution Chart
        const roiCtx = document.getElementById('roi-chart').getContext('2d');
        roiChart = new Chart(roiCtx, {
            type: 'bar',
            data: {
                labels: ['< -50%', '-50% to -20%', '-20% to 0%', '0% to 20%', '20% to 50%', '50% to 100%', '> 100%'],
                datasets: [{
                    label: 'Signals',
                    data: [],
                    backgroundColor: [
                        '#ef4444', '#f97316', '#f59e0b',
                        '#84cc16', '#22c55e', '#10b981', '#14b8a6'
                    ],
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        grid: { color: '#334155' },
                        ticks: { color: '#94a3b8' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#94a3b8', maxRotation: 45 }
                    }
                }
            }
        });
    }
    
    async function loadAnalyticsData() {
        await Promise.all([
            loadHistoricalData(),
            loadChannelLeaderboard(),
            loadPatterns(),
            loadTokenStats(),
        ]);
    }
    
    async function loadHistoricalData() {
        try {
            const start = performance.now();
            const response = await fetch('/api/v1/analytics/historical?days=30&limit=100000');
            const elapsed = performance.now() - start;
            
            const data = await response.json();
            const cacheStatus = response.headers.get('X-Cache-Status') || (data.cached ? 'HIT' : 'MISS');
            
            document.getElementById('historical-cache').textContent = 
                `${cacheStatus} | ${elapsed.toFixed(0)}ms | ${data.total_count?.toLocaleString()} records`;
            
            // Process data for chart (mock daily aggregation)
            if (data.signals && data.signals.length > 0) {
                const dailyData = {};
                data.signals.forEach(s => {
                    const date = s.timestamp.split('T')[0];
                    if (!dailyData[date]) {
                        dailyData[date] = { roi: [], count: 0 };
                    }
                    if (s.roi_percent !== null) {
                        dailyData[date].roi.push(s.roi_percent);
                    }
                    dailyData[date].count++;
                });
                
                const sortedDates = Object.keys(dailyData).sort().slice(-30);
                const avgRoi = sortedDates.map(d => {
                    const rois = dailyData[d].roi;
                    return rois.length > 0 ? rois.reduce((a, b) => a + b, 0) / rois.length : 0;
                });
                
                performanceChart.data.labels = sortedDates.map(d => d.slice(5)); // MM-DD
                performanceChart.data.datasets[0].data = avgRoi;
                performanceChart.update();
                
                // Update ROI distribution chart
                if (data.summary?.sentiment_distribution) {
                    const sentDist = data.summary.sentiment_distribution;
                    sentimentTrendChart.data.datasets[0].data = [sentDist.BULLISH || 0];
                    sentimentTrendChart.data.datasets[1].data = [sentDist.BEARISH || 0];
                    sentimentTrendChart.data.datasets[2].data = [sentDist.NEUTRAL || 0];
                    sentimentTrendChart.data.labels = ['All Time'];
                    sentimentTrendChart.update();
                }
            }
            
        } catch (error) {
            console.error('Error loading historical data:', error);
        }
    }
    
    async function loadChannelLeaderboard() {
        try {
            const start = performance.now();
            const response = await fetch('/api/v1/analytics/channels/leaderboard');
            const elapsed = performance.now() - start;
            
            const data = await response.json();
            const cacheStatus = response.headers.get('X-Cache-Status') || (data.cached ? 'HIT' : 'MISS');
            
            document.getElementById('leaderboard-cache').textContent = 
                `${cacheStatus} | ${elapsed.toFixed(0)}ms`;
            
            renderLeaderboard(data.leaderboard || []);
            
        } catch (error) {
            console.error('Error loading leaderboard:', error);
        }
    }
    
    function renderLeaderboard(leaderboard) {
        // Desktop table
        const tbody = document.getElementById('leaderboard-body');
        tbody.innerHTML = leaderboard.map((ch, i) => `
            <tr class="hover:bg-slate-700/50 transition-smooth">
                <td class="px-4 py-3 font-bold ${i < 3 ? 'text-yellow-500' : ''}">#${ch.rank}</td>
                <td class="px-4 py-3 font-medium">${ch.channel_name}</td>
                <td class="px-4 py-3 text-right">${ch.total_signals?.toLocaleString()}</td>
                <td class="px-4 py-3 text-right text-green-500">${ch.success_rate?.toFixed(1)}%</td>
                <td class="px-4 py-3 text-right ${ch.avg_roi >= 0 ? 'text-green-500' : 'text-red-500'}">
                    ${ch.avg_roi >= 0 ? '+' : ''}${ch.avg_roi?.toFixed(2)}%
                </td>
                <td class="px-4 py-3 text-right font-medium">${ch.score?.toFixed(1)}</td>
                <td class="px-4 py-3 text-center">
                    <span class="bg-green-500/20 text-green-400 px-2 py-0.5 rounded text-xs">
                        ${ch.win_streak}üî•
                    </span>
                </td>
                <td class="px-4 py-3">${ch.top_token}</td>
            </tr>
        `).join('');
        
        // Mobile cards
        const cards = document.getElementById('leaderboard-cards');
        cards.innerHTML = leaderboard.map((ch, i) => `
            <div class="p-4">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <span class="font-bold ${i < 3 ? 'text-yellow-500' : ''}">#${ch.rank}</span>
                        <span class="font-medium ml-2">${ch.channel_name}</span>
                    </div>
                    <span class="text-xs bg-slate-700 px-2 py-1 rounded">Score: ${ch.score?.toFixed(1)}</span>
                </div>
                <div class="grid grid-cols-3 gap-2 text-sm">
                    <div>
                        <p class="text-slate-400">Signals</p>
                        <p class="font-medium">${ch.total_signals?.toLocaleString()}</p>
                    </div>
                    <div>
                        <p class="text-slate-400">Success</p>
                        <p class="font-medium text-green-500">${ch.success_rate?.toFixed(1)}%</p>
                    </div>
                    <div>
                        <p class="text-slate-400">Avg ROI</p>
                        <p class="font-medium ${ch.avg_roi >= 0 ? 'text-green-500' : 'text-red-500'}">
                            ${ch.avg_roi >= 0 ? '+' : ''}${ch.avg_roi?.toFixed(1)}%
                        </p>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    async function loadPatterns() {
        try {
            const start = performance.now();
            const response = await fetch('/api/v1/analytics/patterns');
            const elapsed = performance.now() - start;
            
            const data = await response.json();
            const cacheStatus = response.headers.get('X-Cache-Status') || (data.cached ? 'HIT' : 'MISS');
            
            document.getElementById('patterns-cache').textContent = 
                `${cacheStatus} | ${elapsed.toFixed(0)}ms | ${data.signals_analyzed?.toLocaleString()} analyzed`;
            
            renderPatterns(data);
            
        } catch (error) {
            console.error('Error loading patterns:', error);
        }
    }
    
    function renderPatterns(data) {
        const container = document.getElementById('patterns-container');
        
        // Market overview card
        let html = `
            <div class="bg-slate-700 rounded-lg p-4">
                <h4 class="font-medium mb-2">Market Phase</h4>
                <p class="text-2xl font-bold ${data.market_phase === 'bull' ? 'text-green-500' : data.market_phase === 'bear' ? 'text-red-500' : 'text-yellow-500'}">
                    ${data.market_phase?.toUpperCase() || 'UNKNOWN'}
                </p>
                <p class="text-sm text-slate-400 mt-1">Sentiment: ${data.dominant_sentiment}</p>
                <p class="text-sm text-slate-400">Strength: ${(data.sentiment_strength * 100)?.toFixed(1)}%</p>
            </div>
            
            <div class="bg-slate-700 rounded-lg p-4">
                <h4 class="font-medium mb-2">Volume Trend</h4>
                <p class="text-2xl font-bold ${data.volume_trend === 'increasing' ? 'text-green-500' : data.volume_trend === 'decreasing' ? 'text-red-500' : 'text-yellow-500'}">
                    ${data.volume_trend?.toUpperCase() || 'STABLE'}
                </p>
                <p class="text-sm text-slate-400 mt-1">Based on ${data.time_period_days} days</p>
            </div>
        `;
        
        // Pattern cards
        if (data.patterns && data.patterns.length > 0) {
            data.patterns.slice(0, 4).forEach(pattern => {
                html += `
                    <div class="bg-slate-700 rounded-lg p-4">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-medium">${pattern.pattern_type.replace('_', ' ').toUpperCase()}</h4>
                            <span class="text-xs bg-primary-500/20 text-primary-400 px-2 py-0.5 rounded">
                                ${(pattern.confidence * 100).toFixed(0)}% conf
                            </span>
                        </div>
                        <p class="text-sm text-slate-300 mb-2">${pattern.description}</p>
                        <p class="text-xs text-slate-400">
                            Tokens: ${pattern.tokens_affected?.join(', ')}
                        </p>
                    </div>
                `;
            });
        }
        
        container.innerHTML = html;
    }
    
    async function loadTokenStats() {
        const symbol = document.getElementById('token-select').value;
        
        try {
            const response = await fetch(`/api/v1/analytics/token/${symbol}/stats`);
            const data = await response.json();
            
            const container = document.getElementById('token-stats');
            
            container.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-700 rounded-lg p-3">
                        <p class="text-xs text-slate-400">Total Signals</p>
                        <p class="text-xl font-bold">${data.total_signals?.toLocaleString() || 0}</p>
                    </div>
                    <div class="bg-slate-700 rounded-lg p-3">
                        <p class="text-xs text-slate-400">Success Rate</p>
                        <p class="text-xl font-bold text-green-500">${data.success_rate?.toFixed(1) || 0}%</p>
                    </div>
                    <div class="bg-slate-700 rounded-lg p-3">
                        <p class="text-xs text-slate-400">Avg ROI</p>
                        <p class="text-xl font-bold ${data.avg_roi >= 0 ? 'text-green-500' : 'text-red-500'}">
                            ${data.avg_roi >= 0 ? '+' : ''}${data.avg_roi?.toFixed(2) || 0}%
                        </p>
                    </div>
                    <div class="bg-slate-700 rounded-lg p-3">
                        <p class="text-xs text-slate-400">Volatility</p>
                        <p class="text-xl font-bold">${data.volatility?.toFixed(2) || 0}</p>
                    </div>
                </div>
                
                <div class="bg-slate-700 rounded-lg p-3">
                    <p class="text-xs text-slate-400 mb-2">Sentiment Breakdown</p>
                    <div class="flex gap-2">
                        <span class="flex-1 bg-green-500/20 text-green-400 text-center py-1 rounded text-sm">
                            üìà ${data.sentiment_distribution?.BULLISH || 0}
                        </span>
                        <span class="flex-1 bg-red-500/20 text-red-400 text-center py-1 rounded text-sm">
                            üìâ ${data.sentiment_distribution?.BEARISH || 0}
                        </span>
                        <span class="flex-1 bg-yellow-500/20 text-yellow-400 text-center py-1 rounded text-sm">
                            ‚û°Ô∏è ${data.sentiment_distribution?.NEUTRAL || 0}
                        </span>
                    </div>
                </div>
                
                <p class="text-xs text-slate-400 text-center">
                    Query time: ${data.query_time_ms?.toFixed(0)}ms | Cache: ${data.cached ? 'HIT' : 'MISS'}
                </p>
            `;
            
            // Update ROI distribution chart
            if (data.roi_distribution) {
                const dist = data.roi_distribution;
                roiChart.data.datasets[0].data = [
                    dist['< -50%'] || 0,
                    dist['-50% to -20%'] || 0,
                    dist['-20% to 0%'] || 0,
                    dist['0% to 20%'] || 0,
                    dist['20% to 50%'] || 0,
                    dist['50% to 100%'] || 0,
                    dist['> 100%'] || 0,
                ];
                roiChart.update();
            }
            
        } catch (error) {
            console.error('Error loading token stats:', error);
        }
    }
    
    async function runBenchmark() {
        const resultsDiv = document.getElementById('benchmark-results');
        const content = document.getElementById('benchmark-content');
        
        resultsDiv.classList.remove('hidden');
        content.innerHTML = '<div class="col-span-full text-center text-slate-400 py-4">Running benchmark...</div>';
        
        try {
            const response = await fetch('/api/v1/analytics/benchmark');
            const data = await response.json();
            
            content.innerHTML = Object.entries(data.benchmark_results).map(([key, result]) => `
                <div class="bg-slate-700 rounded-lg p-4">
                    <h4 class="font-medium mb-2">${key.charAt(0).toUpperCase() + key.slice(1)}</h4>
                    <p class="text-2xl font-bold text-red-400">${result.uncached_ms}ms</p>
                    <p class="text-xs text-slate-400">Uncached (100k+ records)</p>
                    <p class="text-lg font-bold text-green-400 mt-2">~10-20ms expected</p>
                    <p class="text-xs text-slate-400">With cache (${result.expected_improvement_factor || result.improvement_factor + 'x'} faster)</p>
                    <p class="text-xs text-slate-500 mt-2">TTL: ${result.cache_ttl_seconds}s</p>
                </div>
            `).join('');
            
        } catch (error) {
            content.innerHTML = '<div class="col-span-full text-center text-red-400 py-4">Benchmark failed: ' + error.message + '</div>';
        }
    }
    
    function exportData(format) {
        const url = format === 'csv' 
            ? '/api/v1/analytics/historical?days=30&limit=100000'
            : '/api/v1/analytics/historical?days=30&limit=100000';
        
        fetch(url)
            .then(res => res.json())
            .then(data => {
                let content, filename, type;
                
                if (format === 'csv') {
                    const headers = ['id', 'token_symbol', 'channel_name', 'sentiment', 'price_at_signal', 'roi_percent', 'timestamp'];
                    const rows = data.signals.map(s => headers.map(h => s[h] || '').join(','));
                    content = [headers.join(','), ...rows].join('\n');
                    filename = 'signals_export.csv';
                    type = 'text/csv';
                } else {
                    content = JSON.stringify(data, null, 2);
                    filename = 'signals_export.json';
                    type = 'application/json';
                }
                
                const blob = new Blob([content], { type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            })
            .catch(err => {
                alert('Export failed: ' + err.message);
            });
    }
    
    function loadSentimentTrend() {
        // Re-load with selected period
        loadHistoricalData();
    }
</script>
{% endblock %}
